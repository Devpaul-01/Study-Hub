{% extends "base.html" %}

{% block title %}Feed - StudyHub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/posts.css') }}">
{% endblock %}

{% block content %}
<!-- Create Post Card -->
<div class="create-post-card">
    <div class="create-post-input" onclick="openCreatePostModal()">
        <img src="{{ current_user.avatar or '/static/assets/default-avatar.png' }}" 
             alt="Your avatar" 
             class="profile-avatar">
        <input type="text" 
               placeholder="What's on your mind, {{ current_user.name.split()[0] }}?" 
               readonly>
    </div>
    
    <div class="create-post-actions">
        <button class="create-action-btn" onclick="openCreatePostModal('image')">
            <span class="icon">üì∑</span>
            <span>Photo</span>
        </button>
        <button class="create-action-btn" onclick="openCreatePostModal('video')">
            <span class="icon">üé•</span>
            <span>Video</span>
        </button>
        <button class="create-action-btn" onclick="openCreatePostModal('document')">
            <span class="icon">üìÑ</span>
            <span>Document</span>
        </button>
    </div>
</div>

<!-- Feed Filters -->
<div class="feed-filters">
    <button class="filter-btn active" data-filter="all" onclick="changeFilter('all')">
        üè† All Posts
    </button>
    <button class="filter-btn" data-filter="following" onclick="changeFilter('following')">
        üë• Following
    </button>
    <button class="filter-btn" data-filter="department" onclick="changeFilter('department')">
        üéì My Department
    </button>
    <button class="filter-btn" data-filter="trending" onclick="changeFilter('trending')">
        üî• Trending
    </button>
</div>

<!-- Posts Feed -->
<div id="posts-feed">
    <!-- Loading skeletons -->
    <div class="post-skeleton">
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
        <div class="skeleton-line"></div>
    </div>
    <div class="post-skeleton">
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
        <div class="skeleton-line"></div>
    </div>
</div>

<!-- Load More -->
<div id="load-more-container" class="text-center hidden" style="margin-top: var(--spacing-xl);">
    <button class="btn btn-secondary" id="load-more-btn" onclick="loadMorePosts()">
        Load More Posts
    </button>
</div>

<!-- Create Post Modal -->
<div id="create-post-modal" class="modal-overlay hidden" onclick="closeCreatePostModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Create Post</h2>
            <button class="modal-close" onclick="closeCreatePostModal()">&times;</button>
        </div>
        
        <form id="create-post-form" class="modal-body">
            <!-- Post Type -->
            <div class="form-group">
                <label class="form-label">Post Type</label>
                <select id="post_type" name="post_type" class="form-select">
                    <option value="discussion">üí¨ Discussion</option>
                    <option value="question">‚ùì Question</option>
                    <option value="problem">üîß Problem</option>
                    <option value="resource">üìö Resource</option>
                    <option value="announcement">üì¢ Announcement</option>
                </select>
            </div>
            
            <!-- Title -->
            <div class="form-group">
                <label for="post_title" class="form-label required">Title</label>
                <input type="text" 
                       id="post_title" 
                       name="title" 
                       class="form-input" 
                       placeholder="Give your post a title..."
                       required>
                <span class="form-error hidden" id="title_error"></span>
            </div>
            
            <!-- Content -->
            <div class="form-group">
                <label for="post_content" class="form-label">Content</label>
                <textarea id="post_content" 
                          name="text_content" 
                          class="form-textarea" 
                          placeholder="Share your thoughts, ask questions, or provide details..."
                          rows="5"></textarea>
            </div>
            
            <!-- Tags -->
            <div class="form-group">
                <label for="post_tags" class="form-label">Tags</label>
                <input type="text" 
                       id="post_tags" 
                       name="tags" 
                       class="form-input" 
                       placeholder="python, web-dev, help (comma-separated)">
                <span class="form-help">Add up to 5 tags</span>
            </div>
            
            <!-- File Upload -->
            <div class="form-group">
                <label class="form-label">Attach File (optional)</label>
                <input type="file" 
                       id="post_resource" 
                       name="resource" 
                       accept="image/*,video/*,.pdf,.doc,.docx"
                       class="form-input">
            </div>
            
            <!-- Thread Toggle -->
            <div class="checkbox-group">
                <input type="checkbox" id="thread_enabled" name="thread_enabled">
                <label for="thread_enabled">
                    Enable collaboration thread for this post
                </label>
            </div>
        </form>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreatePostModal()">Cancel</button>
            <button class="btn btn-primary" id="submit-post-btn" onclick="submitPost()">
                Post
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/feed.js') }}"></script>
<script>
    // Global state
    let currentFilter = 'all';
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    // Initialize feed on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (!isAuthenticated()) {
            window.location.href = '/student/login';
            return;
        }
        
        loadFeed();
    });

    // Load feed
    async function loadFeed() {
        isLoading = true;
        
        try {
            const response = await api.get('/posts/feed', {
                filter: currentFilter,
                page: currentPage,
                per_page: 10
            });
            
            if (response.status === 'success') {
                const feedContainer = document.getElementById('posts-feed');
                
                // Clear loading skeletons on first load
                if (currentPage === 1) {
                    feedContainer.innerHTML = '';
                }
                
                // Render posts
                response.data.posts.forEach(post => {
                    feedContainer.innerHTML += renderPostCard(post);
                });
                
                // Check if there are more posts
                hasMore = response.data.pagination.page < response.data.pagination.pages;
                
                // Show/hide load more button
                document.getElementById('load-more-container').classList.toggle('hidden', !hasMore);
                
                // If no posts
                if (response.data.posts.length === 0 && currentPage === 1) {
                    feedContainer.innerHTML = `
                        <div class="card text-center" style="padding: var(--spacing-2xl);">
                            <h3>No posts yet</h3>
                            <p class="text-muted">Be the first to share something!</p>
                            <button class="btn btn-primary" onclick="openCreatePostModal()">
                                Create Post
                            </button>
                        </div>
                    `;
                }
            }
        } catch (error) {
            handleAPIError(error);
        } finally {
            isLoading = false;
        }
    }

    // Change filter
    function changeFilter(filter) {
        currentFilter = filter;
        currentPage = 1;
        hasMore = true;
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        
        loadFeed();
    }

    // Load more posts
    function loadMorePosts() {
        if (isLoading || !hasMore) return;
        currentPage++;
        loadFeed();
    }

    // Render post card HTML
    function renderPostCard(post) {
        const typeIcons = {
            question: '‚ùì',
            discussion: 'üí¨',
            problem: 'üîß',
            resource: 'üìö',
            announcement: 'üì¢'
        };
        return `
  <div class="post-card" data-post-id="${post.id}">
    <div class="post-header">
      <img src="${post.author?.avatar || '/static/assets/default-avatar.png'}" 
           alt="${post.author?.name}" 
           class="post-avatar">
      <div class="post-author-info">
        <a href="${permissions.can_edit ? '/student/profile' : '/student/profile/' + post.author?.username}" class="post-author-name">${post.author?.name}
        </a>
        </a>
        ${permissions.connection_with_author ? `
          <div class="connection-status">Connected</div>
        ` : ''}
        <div class="post-meta">
          <span class="post-meta-item">
            ${typeIcons[post.post_type] || 'üí¨'} ${post.post_type}
          </span>
          <span>‚Ä¢</span>
          <span>${formatDate(post.posted_at)}</span>
          ${post.department ? `
            <span>‚Ä¢</span>
            <span>üéì ${post.department}</span>
          ` : ''}
        </div>
      </div>
      
      <!-- Author-only actions -->
      ${permissions.can_edit || permissions.can_delete || permissions.can_mark_solved ? `
        <div class="post-actions">
          ${permissions.can_edit ? `
            <button class="edit-post-btn" onclick="editPost(${post.id})">‚úèÔ∏è Edit</button>
          ` : ''}
          ${permissions.can_delete ? `
            <button class="delete-post-btn" onclick="deletePost(${post.id})">üóëÔ∏è Delete</button>
          ` : ''}
          ${permissions.can_mark_solved ? `<button class="mark-solved-btn ${post.is_solved ? 'solved' : ''}" onclick="toggleSolved(${post.id}, this)">${post.is_solved ? '‚úÖ Solved' : '‚úîÔ∏è Mark Solved'}
            </button>` : ''}
        </div>
      ` : ''}
    </div>
    
    <div class="post-content">
      <h3 class="post-title">
        <a href="/student/posts/${post.id}" style="color: inherit; text-decoration: none;">
          ${post.title}
        </a>
      </h3>

      ${post.excerpt ? `
        <p class="post-text truncated">${post.excerpt}</p>
        <button class="read-more-btn" onclick="window.location.href='/student/posts/${post.id}'">
          Read more
        </button>
      ` : ''}

      ${post.tags && post.tags.length > 0 ? `
        <div class="post-tags">
          ${post.tags.map(tag => `
            <a href="/student/search?tags=${tag}" class="post-tag">#${tag}</a>
          `).join('')}
        </div>
      ` : ''}
    </div>

    <!-- Comment Section -->
    ${permissions.can_comment ? `
      <div class="comment-section">
        <textarea class="comment-input" placeholder="Write a comment..."></textarea>
        <button class="comment-submit-btn" onclick="submitComment(${post.id})">Post</button>
      </div>
    ` : `
      <div class="comments-locked">üí¨ Comments are locked for this post.</div>
    `}

    <!-- Post Footer -->
    <div class="post-footer">
      <button class="post-action-btn ${post.user_interaction?.liked === 'like' ? 'liked' : ''}" 
              onclick="toggleLike(${post.id}, this)">
        <span class="icon">${post.user_interaction?.liked === 'like' ? '‚ù§Ô∏è' : 'ü§ç'}</span>
        <span>${post.likes_count}</span>
      </button>
      
      <button class="post-action-btn" onclick="window.location.href='/student/posts/${post.id}#comments'">
        <span class="icon">üí¨</span>
        <span>${post.comments_count}</span>
      </button>
      
      <button class="post-action-btn ${post.user_interaction?.bookmarked ? 'active' : ''}" 
              onclick="toggleBookmark(${post.id}, this)">
        <span class="icon">${post.user_interaction?.bookmarked ? 'üîñ' : 'üîó'}</span>
        <span>${post.user_interaction?.bookmarked ? 'Saved' : 'Save'}</span>
      </button>
      
      <button class="post-action-btn" onclick="sharePost(${post.id})">
        <span class="icon">‚ÜóÔ∏è</span>
        <span>Share</span>
      </button>
    </div>
  </div>
`;
        
        
          

    // Modal functions
    function openCreatePostModal(mediaType) {
        document.getElementById('create-post-modal').classList.remove('hidden');
        document.getElementById('post_title').focus();
    }

    function closeCreatePostModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('create-post-modal').classList.add('hidden');
        document.getElementById('create-post-form').reset();
    }

    // Submit post
    async function submitPost() {
        const form = document.getElementById('create-post-form');
        const submitBtn = document.getElementById('submit-post-btn');
        
        const title = document.getElementById('post_title').value.trim();
        const content = document.getElementById('post_content').value.trim();
        const type = document.getElementById('post_type').value;
        const tags = document.getElementById('post_tags').value.split(',').map(t => t.trim()).filter(t => t);
        const threadEnabled = document.getElementById('thread_enabled').checked;
        const fileInput = document.getElementById('post_resource');
        
        // Validation
        if (!title) {
            showToast('Please enter a title', 'error');
            return;
        }
        
        setButtonLoading(submitBtn, true);
        
        try {
            const formData = new FormData();
            formData.append('title', title);
            formData.append('text_content', content);
            formData.append('post_type', type);
            formData.append('tags', JSON.stringify(tags.slice(0, 5)));
            formData.append('thread_enabled', threadEnabled);
            
            if (fileInput.files[0]) {
                formData.append('resource', fileInput.files[0]);
            }
            
            const response = await api.post('/posts/create', formData, true);
            
            if (response.status === 'success') {
                showToast('Post created successfully!', 'success');
                closeCreatePostModal();
                
                // Reload feed
                currentPage = 1;
                loadFeed();
            }
        } catch (error) {
            handleAPIError(error);
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    // Toggle like
    async function toggleLike(postId, button) {
        try {
            await api.post(`/posts/${postId}/like`, { type: 'like' });
            
            // Toggle UI
            button.classList.toggle('liked');
            const icon = button.querySelector('.icon');
            const count = button.querySelector('span:last-child');
            
            if (button.classList.contains('liked')) {
                icon.textContent = '‚ù§Ô∏è';
                count.textContent = parseInt(count.textContent) + 1;
            } else {
                icon.textContent = 'ü§ç';
                count.textContent = parseInt(count.textContent) - 1;
            }
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Toggle bookmark
    async function toggleBookmark(postId, button) {
        try {
            if (button.classList.contains('active')) {
                await api.delete(`/posts/${postId}/bookmark`);
                button.classList.remove('active');
                button.querySelector('.icon').textContent = 'üîó';
                button.querySelector('span:last-child').textContent = 'Save';
                showToast('Removed from bookmarks', 'info');
            } else {
                await api.post(`/posts/${postId}/bookmark`);
                button.classList.add('active');
                button.querySelector('.icon').textContent = 'üîñ';
                button.querySelector('span:last-child').textContent = 'Saved';
                showToast('Added to bookmarks!', 'success');
            }
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Share post
    function editPost(id){
      window.location.href = `/student/posts/${id}`;
    }
    function sharePost(postId) {
        const url = `${window.location.origin}/student/posts/${postId}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Check out this post on StudyHub',
                url: url
            });
        } else {
            navigator.clipboard.writeText(url);
            showToast('Link copied to clipboard!', 'success');
        }
    }
    async function deletePost(id){
      try{
        const response = await api.delete(`posts/${id}`)
        if(response.status === "success"){
          showToast("Post deleted successfully", "success");
          loadFeed();
          window.location.href = "/student/posts/feed";
        }
        else{
          showToast("Unable to delete post please try again later", "error");
        }
      }
      catch(error){
        loadFeed();
        showToast("Error encountered while trying to delete post please try again later", "error")
      }
      async function markPostSolved(id){
        try{
          const response = await api.post(`/posts/${id}/mark-solved`)
          if (response.status === "success"){
            showToast("Post marked ad solved successfully", "success")
            loadFeed();
            window.location.href = 
          }
          else{
            showToast("Unable to mark post as solved please try again later", "error");
          }
        }
        catch(error){
          loadFeed();
          showToast("Error encountered while trying to delete post please try again later", "error");
        }
      }
      }
    }
</script>
{% endblock %}