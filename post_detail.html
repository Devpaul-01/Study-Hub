{% extends "base.html" %}

{% block title %}Post - StudyHub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/posts.css') }}">
{% endblock %}

{% block content %}
<!-- Back Button -->
<div style="margin-bottom: var(--spacing-lg);">
    <a href="{{ url_for('student_dashboard.feed') }}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 8px;">
        ‚Üê Back to Feed
    </a>
</div>

<!-- Post Detail Container -->
<div id="post-detail-container">
    <!-- Loading State -->
    <div class="post-skeleton">
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
    </div>
</div>

<!-- Comments Section -->
<div id="comments-container" class="hidden">
    <div class="card" style="margin-top: var(--spacing-lg);">
        <h3 style="margin-bottom: var(--spacing-lg);">
            üí¨ Comments (<span id="comment-count">0</span>)
        </h3>
        
        <!-- Comment Input -->
        <div class="comment-input-wrapper">
            <img src="{{ current_user.avatar or '/static/assets/default-avatar.png' }}" 
                 alt="Your avatar" 
                 class="comment-avatar">
            <div class="comment-input" id="comment-input-box">
                <input type="text" 
                       id="comment-text-input" 
                       placeholder="Write a comment..." 
                       maxlength="500">
                <button onclick="addAttachment()">üì∑</button>
                <button onclick="toggleVoiceNote()">üé§</button>
                <button onclick="submitComment()" style="color: var(--primary-blue);">‚û§</button>
            </div>
        </div>
        
        <!-- Comments List -->
        <div id="comments-list">
            <!-- Comments will be loaded here -->
        </div>
        
        <!-- Load More Comments -->
        <div id="load-more-comments" class="text-center hidden" style="margin-top: var(--spacing-lg);">
            <button class="btn btn-secondary" onclick="loadMoreComments()">
                Load More Comments
            </button>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div id="reply-modal" class="modal-overlay hidden" onclick="closeReplyModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Reply to Comment</h3>
            <button class="modal-close" onclick="closeReplyModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <!-- Original Comment Preview -->
            <div id="reply-preview" class="card" style="background: var(--gray-50); margin-bottom: var(--spacing-md);">
                <!-- Will be populated -->
            </div>
            
            <!-- Reply Input -->
            <div class="form-group">
                <textarea id="reply-text-input" 
                          class="form-textarea" 
                          placeholder="Write your reply..."
                          rows="4"
                          maxlength="500"></textarea>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReplyModal()">Cancel</button>
            <button class="btn btn-primary" id="submit-reply-btn" onclick="submitReply()">
                Reply
            </button>
        </div>
    </div>
</div>

<!-- Reaction Picker -->
<div id="reaction-picker" class="hidden" style="position: fixed; background: white; border-radius: 50px; padding: 8px; box-shadow: var(--shadow-lg); z-index: 999;">
    <button onclick="reactToPost('like')" style="font-size: 1.5rem; padding: 8px; border: none; background: none; cursor: pointer;">üëç</button>
    <button onclick="reactToPost('love')" style="font-size: 1.5rem; padding: 8px; border: none; background: none; cursor: pointer;">‚ù§Ô∏è</button>
    <button onclick="reactToPost('laugh')" style="font-size: 1.5rem; padding: 8px; border: none; background: none; cursor: pointer;">üòÇ</button>
    <button onclick="reactToPost('wow')" style="font-size: 1.5rem; padding: 8px; border: none; background: none; cursor: pointer;">üòÆ</button>
    <button onclick="reactToPost('helpful')" style="font-size: 1.5rem; padding: 8px; border: none; background: none; cursor: pointer;">üí°</button>
    <button onclick="reactToPost('fire')" style="font-size: 1.5rem; padding: 8px; border: none; background: none; cursor: pointer;">üî•</button>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/core/api.js') }}"></script>
<script>
    // Global state
    let postId = null;
    let currentPost = null;
    let commentsPage = 1;
    let hasMoreComments = true;
    let replyingToCommentId = null;

    // Get post ID from URL
    const pathParts = window.location.pathname.split('/');
    postId = pathParts[pathParts.length - 1];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        if (!isAuthenticated()) {
            window.location.href = '/student/login';
            return;
        }
        
        loadPost();
        loadComments();
    });

    // Load post details
    async function loadPost() {
        try {
            const response = await api.get(`/posts/${postId}`);
            
            if (response.status === 'success') {
                currentPost = response.data;
                renderPostDetail(response.data);
            }
        } catch (error) {
            handleAPIError(error);
            document.getElementById('post-detail-container').innerHTML = `
                <div class="card text-center" style="padding: var(--spacing-2xl);">
                    <h3>Post not found</h3>
                    <p class="text-muted">This post may have been deleted or you don't have permission to view it.</p>
                    <a href="/student/feed" class="btn btn-primary">Back to Feed</a>
                </div>
            `;
        }
    }

    // Render post detail
    function renderPostDetail(data) {
        const post = data.post;
        const stats = data.stats;
        const author = data.author;
        const userInteraction = data.user_interaction;
        const permissions = data.permissions;
        
        const typeEmojis = {
            question: '‚ùì',
            discussion: 'üí¨',
            problem: 'üîß',
            resource: 'üìö',
            announcement: 'üì¢'
        };

        const html = `
            <div class="card">
                <!-- Post Header -->
                <div class="post-header">
                    <img src="${author?.avatar || '/static/assets/default-avatar.png'}" 
                         alt="${author?.name}" 
                         class="post-avatar">
                    <div class="post-author-info">
                        <a href="/student/profile/${author?.username}" class="post-author-name">
                            ${author?.name}
                        </a>
                        <div class="post-meta">
                            <span>${typeEmojis[post.post_type] || 'üí¨'} ${post.post_type}</span>
                            <span>‚Ä¢</span>
                            <span>${formatDate(post.posted_at)}</span>
                            ${post.edited_at ? `<span>‚Ä¢</span><span class="text-muted">Edited</span>` : ''}
                            ${author?.department ? `
                                <span>‚Ä¢</span>
                                <span>üéì ${author.department}</span>
                            ` : ''}
                        </div>
                    </div>
                    ${permissions.can_edit ? `
                        <button class="post-menu-btn" onclick="showPostMenu()">‚ãÆ</button>
                    ` : ''}
                </div>

                <!-- Post Content -->
                <div class="post-content">
                    ${post.is_solved ? `
                        <div class="post-type-badge solved" style="margin-bottom: var(--spacing-md);">
                            ‚úÖ Solved
                        </div>
                    ` : ''}
                    
                    <h1 class="post-title">${post.title}</h1>
                    
                    ${post.text_content ? `
                        <p class="post-text" style="-webkit-line-clamp: unset;">${post.text_content}</p>
                    ` : ''}
                    
                    ${post.resource ? renderMediaPreview(post.resource, post.resource_type) : ''}
                    
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="post-tags" style="margin-top: var(--spacing-lg);">
                            ${post.tags.map(tag => `
                                <a href="/student/search?tags=${tag}" class="post-tag">#${tag}</a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>

                <!-- Reaction Summary Bar -->
                ${stats.reactions && Object.keys(stats.reactions).length > 0 ? `
                    <div class="reaction-bar">
                        ${Object.entries(stats.reactions).map(([type, count]) => `
                            <span class="reaction-item">
                                <span class="reaction-emoji">${getReactionEmoji(type)}</span>
                                <span>${count}</span>
                            </span>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Action Buttons -->
                <div class="post-footer">
                    <button class="post-action-btn ${userInteraction.liked === 'like' ? 'liked' : ''}" 
                            onclick="toggleLike()"
                            oncontextmenu="showReactionPicker(event); return false;">
                        <span class="icon">${userInteraction.liked === 'like' ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                        <span>${stats.likes_count}</span>
                    </button>
                    
                    <button class="post-action-btn" onclick="focusCommentInput()">
                        <span class="icon">üí¨</span>
                        <span id="header-comment-count">${stats.comments_count}</span>
                    </button>
                    
                    <button class="post-action-btn ${userInteraction.reaction ? 'active' : ''}" 
                            onclick="showReactionPicker(event)">
                        <span class="icon">${userInteraction.reaction ? getReactionEmoji(userInteraction.reaction) : 'üëç'}</span>
                        <span>React</span>
                    </button>
                    
                    <button class="post-action-btn ${userInteraction.bookmarked ? 'active' : ''}" 
                            onclick="toggleBookmark()">
                        <span class="icon">${userInteraction.bookmarked ? 'üîñ' : 'üîó'}</span>
                        <span>${userInteraction.bookmarked ? 'Saved' : 'Save'}</span>
                    </button>
                    
                    <button class="post-action-btn" onclick="sharePost()">
                        <span class="icon">‚ÜóÔ∏è</span>
                        <span>Share</span>
                    </button>
                    
                    ${permissions.can_mark_solved && !post.is_solved ? `
                        <button class="post-action-btn" onclick="markAsSolved()">
                            <span class="icon">‚úÖ</span>
                            <span>Mark Solved</span>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        
        document.getElementById('post-detail-container').innerHTML = html;
        document.getElementById('comments-container').classList.remove('hidden');
        document.getElementById('comment-count').textContent = stats.comments_count;
    }

    // Render media preview
    function renderMediaPreview(resource, type) {
        if (type === 'image') {
            return `<div class="post-media"><img src="/static/upload/${resource}" alt="Post image"></div>`;
        } else if (type === 'video') {
            return `<div class="post-media"><video controls src="/static/upload/${resource}"></video></div>`;
        } else if (type === 'document') {
            return `
                <div class="card" style="background: var(--gray-50); padding: var(--spacing-md); margin: var(--spacing-md) 0;">
                    <a href="/static/upload/${resource}" target="_blank" style="display: flex; align-items: center; gap: var(--spacing-md); text-decoration: none;">
                        <span style="font-size: 2rem;">üìÑ</span>
                        <div>
                            <div style="font-weight: 600; color: var(--gray-900);">Attached Document</div>
                            <div style="font-size: 0.875rem; color: var(--gray-500);">Click to view or download</div>
                        </div>
                    </a>
                </div>
            `;
        }
        return '';
    }

    // Get reaction emoji
    function getReactionEmoji(type) {
        const emojis = {
            like: 'üëç',
            love: '‚ù§Ô∏è',
            laugh: 'üòÇ',
            wow: 'üòÆ',
            helpful: 'üí°',
            fire: 'üî•'
        };
        return emojis[type] || 'üëç';
    }

    // Load comments
    async function loadComments() {
        try {
            const response = await api.get(`/posts/${postId}/comments`, {
                page: commentsPage,
                per_page: 20,
                sort: 'recent'
            });
            
            if (response.status === 'success') {
                const commentsList = document.getElementById('comments-list');
                
                // Clear on first page
                if (commentsPage === 1) {
                    commentsList.innerHTML = '';
                }
                
                // Render comments
                response.data.comments.forEach(comment => {
                    commentsList.innerHTML += renderComment(comment);
                });
                
                // Check if more comments
                hasMoreComments = response.data.pagination.page < response.data.pagination.pages;
                document.getElementById('load-more-comments').classList.toggle('hidden', !hasMoreComments);
                
                // No comments message
                if (response.data.comments.length === 0 && commentsPage === 1) {
                    commentsList.innerHTML = `
                        <div class="text-center" style="padding: var(--spacing-xl); color: var(--gray-500);">
                            <p>No comments yet. Be the first to comment!</p>
                        </div>
                    `;
                }
            }
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Render comment
    function renderComment(comment, isReply = false) {
        return `
            <div class="comment-card ${isReply ? 'reply' : ''}" id="comment-${comment.id}">
                <div class="comment-header">
                    <img src="${comment.author?.avatar || '/static/assets/default-avatar.png'}" 
                         alt="${comment.author?.name}" 
                         class="comment-avatar">
                    <span class="comment-author">${comment.author?.name}</span>
                    <span class="comment-time">${formatDate(comment.posted_at)}</span>
                    ${comment.is_solution ? `
                        <span class="comment-solution-badge">‚úÖ Solution</span>
                    ` : ''}
                </div>
                
                <div class="comment-content">${comment.text_content}</div>
                
                <div class="comment-actions">
                    <button class="comment-action-btn ${comment.user_liked ? 'active' : ''}" 
                            onclick="toggleCommentLike(${comment.id}, this)">
                        üëç ${comment.likes_count}
                    </button>
                    <button class="comment-action-btn" onclick="openReplyModal(${comment.id}, '${comment.author?.name}')">
                        üí¨ Reply
                    </button>
                    ${comment.is_author && currentPost.post.post_type === 'question' && !comment.is_solution ? `
                        <button class="comment-action-btn" onclick="markCommentAsSolution(${comment.id})">
                            ‚úÖ Mark as Solution
                        </button>
                    ` : ''}
                    ${comment.is_author ? `
                        <button class="comment-action-btn text-danger" onclick="deleteComment(${comment.id})">
                            üóëÔ∏è Delete
                        </button>
                    ` : ''}
                </div>
                
                ${comment.replies_count > 0 ? `
                    <div style="margin-top: var(--spacing-md);">
                        <button class="btn btn-sm btn-secondary" onclick="loadReplies(${comment.id})">
                            View ${comment.replies_count} ${comment.replies_count === 1 ? 'reply' : 'replies'}
                        </button>
                    </div>
                    <div id="replies-${comment.id}"></div>
                ` : ''}
            </div>
        `;
    }

    // Submit comment
    async function submitComment() {
        const input = document.getElementById('comment-text-input');
        const text = input.value.trim();
        
        if (!text) {
            showToast('Please write something', 'error');
            return;
        }
        
        try {
            const response = await api.post(`/posts/${postId}/comments`, {
                text_content: text
            });
            
            if (response.status === 'success') {
                showToast('Comment posted!', 'success');
                input.value = '';
                
                // Reload comments
                commentsPage = 1;
                loadComments();
                
                // Update comment count
                const count = parseInt(document.getElementById('comment-count').textContent);
                document.getElementById('comment-count').textContent = count + 1;
                document.getElementById('header-comment-count').textContent = count + 1;
            }
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Comment input: press Enter to submit
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('comment-text-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitComment();
            }
        });
    });

    // Toggle like
    async function toggleLike() {
        try {
            await api.post(`/posts/${postId}/like`, { type: 'like' });
            loadPost(); // Reload to get updated counts
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Toggle bookmark
    async function toggleBookmark() {
        try {
            const isBookmarked = currentPost.user_interaction.bookmarked;
            
            if (isBookmarked) {
                await api.delete(`/posts/${postId}/bookmark`);
                showToast('Removed from bookmarks', 'info');
            } else {
                await api.post(`/posts/${postId}/bookmark`);
                showToast('Added to bookmarks!', 'success');
            }
            loadPost();
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Show reaction picker
    function showReactionPicker(event) {
        event.preventDefault();
        const picker = document.getElementById('reaction-picker');
        picker.style.left = event.pageX + 'px';
        picker.style.top = (event.pageY - 50) + 'px';
        picker.classList.remove('hidden');
        
        // Hide after 5 seconds or on click outside
        setTimeout(() => picker.classList.add('hidden'), 5000);
        document.addEventListener('click', () => picker.classList.add('hidden'), { once: true });
    }

    // React to post
    async function reactToPost(reactionType) {
        try {
            await api.post(`/posts/${postId}/react`, { reaction: reactionType });
            document.getElementById('reaction-picker').classList.add('hidden');
            loadPost();
            showToast(`Reacted with ${getReactionEmoji(reactionType)}`, 'success');
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Toggle comment like
    async function toggleCommentLike(commentId, button) {
        try {
            await api.post(`/comments/${commentId}/like`);
            button.classList.toggle('active');
            
            const countSpan = button.textContent.match(/\d+/);
            const currentCount = parseInt(countSpan ? countSpan[0] : 0);
            button.innerHTML = button.classList.contains('active') 
                ? `üëç ${currentCount + 1}`
                : `üëç ${Math.max(0, currentCount - 1)}`;
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Open reply modal
    function openReplyModal(commentId, authorName) {
        replyingToCommentId = commentId;
        document.getElementById('reply-modal').classList.remove('hidden');
        document.getElementById('reply-preview').innerHTML = `
            <p class="text-muted" style="font-size: 0.9rem; margin: 0;">
                Replying to <strong>${authorName}</strong>
            </p>
        `;
        document.getElementById('reply-text-input').focus();
    }

    // Close reply modal
    function closeReplyModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('reply-modal').classList.add('hidden');
        document.getElementById('reply-text-input').value = '';
        replyingToCommentId = null;
    }

    // Submit reply
    async function submitReply() {
        const text = document.getElementById('reply-text-input').value.trim();
        
        if (!text) {
            showToast('Please write something', 'error');
            return;
        }
        
        const submitBtn = document.getElementById('submit-reply-btn');
        setButtonLoading(submitBtn, true);
        
        try {
            const response = await api.post(`/posts/${postId}/comments`, {
                text_content: text,
                parent_id: replyingToCommentId
            });
            
            if (response.status === 'success') {
                showToast('Reply posted!', 'success');
                closeReplyModal();
                
                // Reload comments
                commentsPage = 1;
                loadComments();
            }
        } catch (error) {
            handleAPIError(error);
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    // Focus comment input
    function focusCommentInput() {
        document.getElementById('comment-text-input').focus();
        document.getElementById('comment-text-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Share post
    function sharePost() {
        const url = window.location.href;
        
        if (navigator.share) {
            navigator.share({
                title: currentPost.post.title,
                url: url
            });
        } else {
            navigator.clipboard.writeText(url);
            showToast('Link copied to clipboard!', 'success');
        }
    }

    // Mark as solved
    async function markAsSolved() {
        if (!confirm('Mark this post as solved?')) return;
        
        try {
            await api.post(`/posts/${postId}/mark-solved`);
            showToast('Post marked as solved!', 'success');
            loadPost();
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Delete comment
    async function deleteComment(commentId) {
        if (!confirm('Delete this comment?')) return;
        
        try {
            await api.delete(`/comments/${commentId}`);
            showToast('Comment deleted', 'success');
            document.getElementById(`comment-${commentId}`).remove();
            
            // Update count
            const count = parseInt(document.getElementById('comment-count').textContent);
            document.getElementById('comment-count').textContent = Math.max(0, count - 1);
        } catch (error) {
            handleAPIError(error);
        }
    }

    // Load more comments
    function loadMoreComments() {
        commentsPage++;
        loadComments();
    }

    // Placeholder functions
    function addAttachment() {
        showToast('File attachment coming soon!', 'info');
    }

    function toggleVoiceNote() {
        showToast('Voice notes coming soon!', 'info');
    }
</script>
{% endblock %}
            
          